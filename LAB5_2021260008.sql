--1 non sub
SELECT
    CUSTOMER_NAME,
    CUSTOMER_CITY,
    CUSTOMER_STREET
FROM
    CUSTOMER
    NATURAL JOIN DEPOSITOR
    NATURAL JOIN ACCOUNT
    NATURAL JOIN BRANCH INTERSECT
    SELECT
        CUSTOMER_NAME,
        BRANCH_CITY,
        CUSTOMER_STREET
    FROM
        CUSTOMER
        NATURAL JOIN DEPOSITOR
        NATURAL JOIN ACCOUNT
        NATURAL JOIN BRANCH;

--1 sub
SELECT
    CUSTOMER_NAME,
    CUSTOMER_STREET,
    CUSTOMER_CITY
FROM
    CUSTOMER  CUS
WHERE
    CUSTOMER_CITY = SOME (
        SELECT
            BRANCH_CITY
        FROM
            BRANCH
            NATURAL JOIN ACCOUNT
            NATURAL JOIN DEPOSITOR
        WHERE
            CUS.CUSTOMER_NAME = DEPOSITOR.CUSTOMER_NAME
    );

--2 non sub
SELECT
    CUSTOMER_NAME,
    CUSTOMER_CITY,
    CUSTOMER_STREET
FROM
    CUSTOMER
    NATURAL JOIN BORROWER
    NATURAL JOIN LOAN
    NATURAL JOIN BRANCH INTERSECT
    SELECT
        CUSTOMER_NAME,
        BRANCH_CITY,
        CUSTOMER_STREET
    FROM
        CUSTOMER
        NATURAL JOIN BORROWER
        NATURAL JOIN LOAN
        NATURAL JOIN BRANCH
 --2 SUB
        SELECT
            CUSTOMER_NAME,
            CUSTOMER_STREET,
            CUSTOMER_CITY
        FROM
            CUSTOMER CUS
        WHERE
            CUS.CUSTOMER_CITY = SOME(
                SELECT
                    BRANCH_CITY
                FROM
                    BRANCH
                    NATURAL JOIN BORROWER
                    NATURAL JOIN LOAN
                WHERE
                    CUS.CUSTOMER_NAME = BORROWER.CUSTOMER_NAME
            );

--3 without having
WITH BALANCE_FROM_1001 AS(
    SELECT
        BRANCH_CITY,
        SUM(BALANCE) AS SUM_BALANCE,
        AVG(BALANCE) AS AVG_BALANCE
    FROM
        BRANCH
        NATURAL JOIN ACCOUNT
    GROUP BY
        BRANCH_CITY
)
SELECT
    BRANCH_CITY,
    AVG_BALANCE
FROM
    BALANCE_FROM_1001 BF
WHERE
    BF.SUM_BALANCE >= 1000;

--3 with having
SELECT
    BRANCH_CITY,
    AVG(BALANCE)
FROM
    BRANCH
    NATURAL JOIN ACCOUNT
GROUP BY
    BRANCH_CITY
HAVING
    SUM(BALANCE) >=1000;